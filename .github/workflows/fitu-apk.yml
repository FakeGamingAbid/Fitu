name: Fitu Build
on:
  workflow_dispatch:
    inputs:
      build_type:
        description: 'What to build?'
        required: true
        default: 'release'
        type: choice
        options:
          - release
          - debug
          - release_aab

permissions:
  contents: write
  actions: write

jobs:
  build:
    runs-on: ubuntu-latest
    
    steps:
    - name: Show Build Type
      run: |
        echo "ðŸ”¨ Build type: ${{ inputs.build_type }}"
        echo "ðŸƒ Run number: ${{ github.run_number }}"

    - name: Checkout Code
      uses: actions/checkout@v4
      with:
        fetch-depth: 0

    - name: Delete Old Artifacts
      uses: actions/github-script@v7
      with:
        script: |
          const owner = context.repo.owner;
          const repo = context.repo.repo;
          const artifacts = await github.rest.actions.listArtifactsForRepo({ 
            owner, 
            repo, 
            per_page: 100 
          });
          const toDelete = artifacts.data.artifacts
            .sort((a, b) => new Date(b.created_at) - new Date(a.created_at))
            .slice(2);
          
          for (const artifact of toDelete) {
            try { 
              await github.rest.actions.deleteArtifact({ 
                owner, 
                repo, 
                artifact_id: artifact.id 
              });
              console.log(`âœ… Deleted artifact: ${artifact.name}`);
            } catch (e) { 
              console.log(`âŒ Failed to delete ${artifact.name}: ${e.message}`); 
            }
          }

    - name: Setup Java 17
      uses: actions/setup-java@v4
      with:
        java-version: '17'
        distribution: 'temurin'
        cache: 'gradle'

    - name: Setup Android SDK
      uses: android-actions/setup-android@v3

    - name: Make Gradlew Executable
      run: chmod +x gradlew

    - name: Validate Gradle Wrapper
      uses: gradle/wrapper-validation-action@v2

    - name: Get Version Name
      id: version
      run: |
        VERSION_NAME=$(grep -E 'versionName.*=.*"' app/build.gradle.kts | sed -E 's/.*"(.*)".*/\1/' | head -n 1)
        VERSION_CODE=$(grep -E 'versionCode.*=.*[0-9]' app/build.gradle.kts | sed -E 's/.*= *([0-9]+).*/\1/' | head -n 1)
        
        if [ -z "$VERSION_NAME" ]; then
          VERSION_NAME="1.0.0"
        fi
        if [ -z "$VERSION_CODE" ]; then
          VERSION_CODE="1"
        fi
        
        echo "version_name=$VERSION_NAME" >> $GITHUB_OUTPUT
        echo "version_code=$VERSION_CODE" >> $GITHUB_OUTPUT
        echo "ðŸ“± App Version: $VERSION_NAME ($VERSION_CODE)"

    - name: Decode Keystore
      if: ${{ inputs.build_type == 'release' || inputs.build_type == 'release_aab' }}
      env:
        KEYSTORE_BASE64: ${{ secrets.KEYSTORE_BASE64 }}
      run: |
        echo "$KEYSTORE_BASE64" | base64 -d > app/release-keystore.jks
        echo "âœ… Keystore decoded successfully"

    - name: Build Debug APK
      if: ${{ inputs.build_type == 'debug' }}
      run: |
        ./gradlew assembleDebug --parallel --build-cache --stacktrace
        echo "ðŸ“¦ Debug APK built successfully"

    - name: Build Release APK
      if: ${{ inputs.build_type == 'release' }}
      env:
        KEYSTORE_PASSWORD: ${{ secrets.KEYSTORE_PASSWORD }}
        KEY_ALIAS: ${{ secrets.KEY_ALIAS }}
        KEY_PASSWORD: ${{ secrets.KEY_PASSWORD }}
      run: |
        ./gradlew assembleRelease --parallel --build-cache --stacktrace
        echo "ðŸ“¦ Release APK built successfully"

    - name: Build Release APK + AAB
      if: ${{ inputs.build_type == 'release_aab' }}
      env:
        KEYSTORE_PASSWORD: ${{ secrets.KEYSTORE_PASSWORD }}
        KEY_ALIAS: ${{ secrets.KEY_ALIAS }}
        KEY_PASSWORD: ${{ secrets.KEY_PASSWORD }}
      run: |
        ./gradlew assembleRelease bundleRelease --parallel --build-cache --stacktrace
        echo "ðŸ“¦ Release APK and AAB built successfully"

    - name: Get Build Info
      if: ${{ inputs.build_type != 'debug' }}
      id: build_info
      run: |
        APK_PATH=$(find app/build/outputs/apk/release -name "*.apk" | head -n 1)
        APK_SIZE=$(du -h "$APK_PATH" | cut -f1)
        echo "apk_size=$APK_SIZE" >> $GITHUB_OUTPUT
        echo "build_date=$(date +'%Y-%m-%d %H:%M:%S UTC')" >> $GITHUB_OUTPUT
        
        if [ "${{ inputs.build_type }}" == "release_aab" ]; then
          AAB_PATH=$(find app/build/outputs/bundle/release -name "*.aab" | head -n 1)
          AAB_SIZE=$(du -h "$AAB_PATH" | cut -f1)
          echo "aab_size=$AAB_SIZE" >> $GITHUB_OUTPUT
        fi

    - name: Upload Debug APK
      if: ${{ inputs.build_type == 'debug' }}
      uses: actions/upload-artifact@v4
      with:
        name: Fitu-Debug-v${{ steps.version.outputs.version_name }}-${{ github.run_number }}
        path: app/build/outputs/apk/debug/*.apk
        retention-days: 1
        if-no-files-found: error

    - name: Create Release and Upload APK
      if: ${{ inputs.build_type == 'release' }}
      uses: ncipollo/release-action@v1
      with:
        tag: "v${{ steps.version.outputs.version_name }}-${{ github.run_number }}"
        name: "Fitu v${{ steps.version.outputs.version_name }} (Build ${{ github.run_number }})"
        body: |
          ## ðŸŽ‰ Fitu Release Build
          
          **Version:** ${{ steps.version.outputs.version_name }} (Code: ${{ steps.version.outputs.version_code }})
          **Build Date:** ${{ steps.build_info.outputs.build_date }}
          **APK Size:** ${{ steps.build_info.outputs.apk_size }}
          **Build Number:** ${{ github.run_number }}
          **Commit:** ${{ github.sha }}
          
          ### ðŸ“¥ Installation
          Download the APK below and install on your Android device.
          
          > **Note:** You may need to enable "Install from Unknown Sources" in your device settings.
          
          ### ðŸ”§ Build Type
          - Release APK (Signed)
        artifacts: "app/build/outputs/apk/release/*.apk"
        token: ${{ secrets.GITHUB_TOKEN }}
        allowUpdates: true
        makeLatest: true

    - name: Create Release and Upload AAB
      if: ${{ inputs.build_type == 'release_aab' }}
      uses: ncipollo/release-action@v1
      with:
        tag: "v${{ steps.version.outputs.version_name }}-${{ github.run_number }}-bundle"
        name: "Fitu v${{ steps.version.outputs.version_name }} Bundle (Build ${{ github.run_number }})"
        body: |
          ## ðŸ“¦ Fitu Bundle Build
          
          **Version:** ${{ steps.version.outputs.version_name }} (Code: ${{ steps.version.outputs.version_code }})
          **Build Date:** ${{ steps.build_info.outputs.build_date }}
          **APK Size:** ${{ steps.build_info.outputs.apk_size }}
          **AAB Size:** ${{ steps.build_info.outputs.aab_size }}
          **Build Number:** ${{ github.run_number }}
          **Commit:** ${{ github.sha }}
          
          ### ðŸ“¥ Downloads
          - **APK:** For direct installation on Android devices
          - **AAB:** For uploading to Google Play Store
          
          ### ðŸ”§ Build Type
          - Release APK (Signed)
          - Release AAB (Signed - Play Store Ready)
          
          > **Play Store:** Use the AAB file for Play Store submissions
        artifacts: "app/build/outputs/bundle/release/*.aab,app/build/outputs/apk/release/*.apk"
        token: ${{ secrets.GITHUB_TOKEN }}
        allowUpdates: true
        makeLatest: true

    - name: Cleanup
      if: always()
      run: |
        rm -f app/release-keystore.jks
        echo "ðŸ§¹ Cleanup completed"

    - name: Build Summary
      if: success()
      run: |
        echo "## âœ… Build Successful!" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "**Build Type:** ${{ inputs.build_type }}" >> $GITHUB_STEP_SUMMARY
        echo "**Version:** ${{ steps.version.outputs.version_name }} (Code: ${{ steps.version.outputs.version_code }})" >> $GITHUB_STEP_SUMMARY
        echo "**Build Number:** ${{ github.run_number }}" >> $GITHUB_STEP_SUMMARY
        echo "**Commit:** ${{ github.sha }}" >> $GITHUB_STEP_SUMMARY
